default:
  image: node:20.11.0-alpine3.18
  before_script:
    - uname -a
    - node --version
    - npm --version

setup:
  stage: build
  script:
    - npm install -g bower
    - bower --version
    # bower needs git
    - apk add --no-cache git
    - bower install --allow-root
    # Install dependencies and cache within the project directory to cache
    # See: https://javascript.plainenglish.io/improving-ci-performance-aka-how-to-save-your-money-31ff691360e4
    - npm ci --cache .npm --prefer-offline
  # Cache modules in between pipelines
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - .npm/
  artifacts:
    # pin artifacts to the branch
    # see: https://docs.gitlab.com/ee/ci/jobs/job_artifacts.html#with-a-dynamically-defined-name
    name: $CI_COMMIT_REF_SLUG
    expire_in: 1 week
    paths:
      - node_modules
      - bower_components

  

deploy_development:
  stage: deploy
  environment: development
  needs:
    - setup
  script:
    - apk add --no-cache lftp
    - lftp --version
    - echo "listing working directory..."
    - ls -la
    - echo "transferring files and listing remote directory..."
    # lftp mirror arguments: https://www.cyberciti.biz/faq/lftp-mirror-example/
    - >
      lftp -e "
        set cmd:fail-exit yes; 
        open $FTP_HOST; 
        user $FTP_USER $FTP_PASSWORD; 
        mirror --exclude-glob='.*' --exclude-glob='.git/*' --include='.htaccess' --exclude='Dockerfile' --exclude='docker-compose.yml' --exclude='bower.json' --exclude='package.json' --exclude='package-lock.json' --exclude='renovate.json5' --exclude='README.md' --exclude='config.json.sample' --exclude='config.json' --reverse --delete --parallel=20 --verbose ./ ./registration/${CI_ENVIRONMENT_NAME}/;
        ls -la registration/${CI_ENVIRONMENT_NAME}; 
        bye
      "
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'

